<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Benis Wetterstation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <style>
    :root {
      --bg:#0f172a; --card:#111827; --fg:#e5e7eb; --muted:#93a4b8; --accent:#60a5fa;
      --maxw: 480px; /* angenehm für Hochkant */
    }
    html,body { height:100%; }
    body {
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: var(--bg); color: var(--fg);
      -webkit-text-size-adjust: 100%;
      padding: env(safe-area-inset-top) 12px env(safe-area-inset-bottom);
    }
    header {
      position: sticky; top: 0; z-index: 10; backdrop-filter: blur(8px);
      background: rgba(15,23,42,.7);
      border-bottom: 1px solid rgba(148,163,184,.2);
      padding: 10px 8px;
    }
    h1 { margin:0; font-size: clamp(20px, 4.8vw, 26px); }
    main { margin: 12px auto 40px; max-width: var(--maxw); }

    .controls { display:flex; gap:10px; align-items:center; overflow:auto; padding:8px 2px; }
    .btn, .input {
      font-size:16px; /* verhindert iPhone-Autozoom */
      padding:12px 14px; border-radius:12px;
      border:1px solid rgba(148,163,184,.25); background:#0b1220; color:var(--fg);
      min-height:44px; /* fingerfreundlich */
    }

    .grid { display:grid; gap:12px; }
    .card {
      background: var(--card);
      border:1px solid rgba(148,163,184,.18);
      border-radius:16px; padding:14px;
      box-shadow: 0 8px 20px rgba(0,0,0,.25);
    }
    .titleRow { display:flex; align-items:center; gap:10px; }
    .iconWrap {
      width:40px; height:40px; display:grid; place-items:center; flex-shrink:0;
      border-radius:12px; border:1px solid rgba(148,163,184,.25);
      background: radial-gradient(500px 200px at -10% -50%, rgba(96,165,250,.20), transparent), #0b1220;
    }
    .iconWrap svg { width:22px; height:22px; color: var(--fg); }
    .card h3 { margin:0; font-size:18px; }

    .muted { color: var(--muted); line-height:1.45; font-size:14px; }
    .metaRow { display:flex; justify-content:space-between; gap:10px; color:var(--muted); font-size:12px; margin-top:6px; }

    .bigValue { font-size: clamp(34px, 9vw, 48px); font-weight: 700; line-height: 1.05; margin: 8px 0 2px; }
    .unit { font-size: 18px; color: var(--muted); margin-left: 6px; }
    canvas { width: 100% !important; height: 240px !important; }
    .error { color:#fecaca; font-size:13px; margin-top:8px; display:none; }
  </style>
</head>
<body>
  <header>
    <h1>Benis Wetterstation</h1>
  </header>

  <main>
    <div class="controls">
      <button id="refreshBtn" class="btn">↻ Aktualisieren</button>
      <select id="resultsSel" class="input">
        <option value="200" selected>Letzte 200 Punkte</option>
        <option value="500">Letzte 500 Punkte</option>
        <option value="1000">Letzte 1000 Punkte</option>
      </select>
    </div>

    <section id="cards" class="grid"></section>
  </main>

  <script>
    // ========= CONFIG =========
    const CONFIG = {
      channelId: 3043993,
      readKey: "5QKSO8HZ6BNPFTDE", // sichtbar im Browser – für Umweltdaten okay
      refreshSec: 60,
      defaultResults: 200,
      fields: [
        { n:1, title: "Temperatur Wohnzimmer", unit:"°C", icon:"thermo", digits:1 },
        { n:2, title: "Luftfeuchte Wohnzimmer", unit:"%", icon:"humidity", digits:0 },
        { n:3, title: "Temperatur Außen Wiesloch", unit:"°C", icon:"thermo-out", digits:1 },
        { n:4, title: "Luftfeuchte Außen Wiesloch", unit:"%", icon:"humidity-out", digits:0 },
        { n:5, title: "UV‑Index", unit:"", icon:"uv", digits:1 }
      ]
    };

    // ========= Hilfsfunktionen =========
    const $ = (q, el=document) => el.querySelector(q);
    function fmt(n, digits=1) {
      const x = Number(n);
      return Number.isFinite(x) ? x.toLocaleString("de-DE", {maximumFractionDigits:digits, minimumFractionDigits:digits}) : "–";
    }
    function labelFromISO(iso) {
      const d = new Date(iso);
      const dd = String(d.getDate()).padStart(2,"0");
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const hh = String(d.getHours()).padStart(2,"0");
      const mi = String(d.getMinutes()).padStart(2,"0");
      return `${dd}.${mm} ${hh}:${mi}`;
    }
    function lastFinite(arr) {
      for (let i=arr.length-1; i>=0; i--) {
        const v = arr[i];
        if (Number.isFinite(v)) return v;
      }
      return null;
    }
    function iconSVG(name) {
      switch(name) {
        case 'thermo':
          return `<svg viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='1.7' stroke-linecap='round' stroke-linejoin='round'>
            <path d='M14 14.76V5a2 2 0 0 0-4 0v9.76a4 4 0 1 0 4 0Z'/>
            <path d='M10 9h4'/>
          </svg>`;
        case 'humidity':
          return `<svg viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='1.7' stroke-linecap='round' stroke-linejoin='round'>
            <path d='M12 2s6 6 6 10a6 6 0 0 1-12 0C6 8 12 2 12 2Z'/>
            <path d='M12 13a2 2 0 0 1-2-2'/>
          </svg>`;
        case 'thermo-out':
          return `<svg viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='1.7' stroke-linecap='round' stroke-linejoin='round'>
            <circle cx='18' cy='6' r='3'/>
            <path d='M18 9v4m0 4v2'/>
            <path d='M14 14.76V5a2 2 0 0 0-4 0v9.76a4 4 0 1 0 4 0Z'/>
          </svg>`;
        case 'humidity-out':
          return `<svg viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='1.7' stroke-linecap='round' stroke-linejoin='round'>
            <path d='M12 2s6 6 6 10a6 6 0 0 1-12 0C6 8 12 2 12 2Z'/>
            <path d='M19 4l2 2m0-2l-2 2'/>
          </svg>`;
        case 'uv':
          return `<svg viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='1.7' stroke-linecap='round' stroke-linejoin='round'>
            <circle cx='12' cy='12' r='4'/>
            <path d='M12 2v2m0 16v2m10-10h-2M4 12H2m15.5-6.5-1.4 1.4M8 17.9l-1.4 1.4m0-13.8L8 6.9m8.1 10.1 1.4 1.4'/>
          </svg>`;
        default:
          return `<svg viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='1.7'><circle cx='12' cy='12' r='9'/></svg>`;
      }
    }

    // ========= UI aufbauen =========
    const cardsEl = document.getElementById('cards');
    const charts = new Map(); // key: field number -> Chart instance

    function buildCard(field) {
      const card = document.createElement('article');
      card.className = 'card';
      card.id = `card-f${field.n}`;
      card.innerHTML = `
        <div class="titleRow">
          <div class="iconWrap">${iconSVG(field.icon)}</div>
          <h3>${field.title}</h3>
        </div>
        <div class="metaRow">
          <span id="time-f${field.n}">Letztes Update: –</span>
          <span id="status-f${field.n}" class="muted">bereit</span>
        </div>
        <div class="bigValue"><span id="val-f${field.n}">–</span><span class="unit"> ${field.unit}</span></div>
        <canvas id="chart-f${field.n}"></canvas>
        <div id="err-f${field.n}" class="error"></div>
      `;
      cardsEl.appendChild(card);
    }

    CONFIG.fields.forEach(buildCard);

    // ========= Daten laden (ein Fetch für alle Felder) =========
    async function loadAll() {
      const results = Number(document.getElementById('resultsSel').value || CONFIG.defaultResults);
      const url = new URL(`https://api.thingspeak.com/channels/${CONFIG.channelId}/feeds.json`);
      url.searchParams.set('results', results);
      if (CONFIG.readKey) url.searchParams.set('api_key', CONFIG.readKey);

      // Status-Fahne
      CONFIG.fields.forEach(f => { document.getElementById(`status-f${f.n}`).textContent = 'lädt…'; });

      try {
        const res = await fetch(url.toString(), { cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        const feeds = Array.isArray(data.feeds) ? data.feeds : [];
        const labels = feeds.map(f => labelFromISO(f.created_at));

        CONFIG.fields.forEach(f => {
          const series = feeds.map(row => {
            const v = parseFloat(row[`field${f.n}`]);
            return Number.isFinite(v) ? v : null;
          });

          // Big number + Zeit
          const last = lastFinite(series);
          document.getElementById(`val-f${f.n}`).textContent = last == null ? '–' : fmt(last, f.digits ?? 1);
          const lastFeed = feeds[feeds.length - 1];
          document.getElementById(`time-f${f.n}`).textContent = lastFeed ? `Letztes Update: ${labelFromISO(lastFeed.created_at)}` : 'Letztes Update: –';

          // Chart zeichnen/aktualisieren
          const ctx = document.getElementById(`chart-f${f.n}`).getContext('2d');
          const old = charts.get(f.n);
          if (old) old.destroy();
          const ch = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets: [{ data: series, borderWidth: 2, pointRadius: 0, tension: 0.25 }] },
            options: {
              responsive: true, maintainAspectRatio: false, animation: false,
              scales: { x: { ticks: { maxTicksLimit: 6 } }, y: { beginAtZero: false } },
              plugins: { legend: { display: false } }
            }
          });
          charts.set(f.n, ch);

          document.getElementById(`status-f${f.n}`).textContent = `OK • ${series.filter(x=>Number.isFinite(x)).length} Punkte`;
          document.getElementById(`err-f${f.n}`).style.display = 'none';
        });

      } catch (e) {
        CONFIG.fields.forEach(f => {
          document.getElementById(`status-f${f.n}`).textContent = 'Fehler';
          const err = document.getElementById(`err-f${f.n}`);
          err.textContent = `Konnte Daten nicht laden: ${e.message}`;
          err.style.display = 'block';
        });
      }
    }

    document.getElementById('refreshBtn').addEventListener('click', loadAll);
    document.getElementById('resultsSel').addEventListener('change', loadAll);

    // Initial + Auto-Refresh
    loadAll();
    setInterval(loadAll, CONFIG.refreshSec * 1000);
  </script>
</body>
</html>
