<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Beni`s Wetterstation</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html, body { height: 100%; }
    .blink { animation: blink 1.2s linear infinite; }
    @keyframes blink { 50% { opacity: .4 } }
    .spin { animation: spin linear infinite; }
    @keyframes spin { from { transform: rotate(0deg) } to { transform: rotate(360deg) } }
    .sunPulse { animation: sunPulse 6s ease-in-out infinite; transform-origin: center; }
    @keyframes sunPulse { 0%,100% { transform: scale(1); opacity: 1 } 50% { transform: scale(1.05); opacity: .95 } }
    .cloudFloat { animation: cloudFloat 18s ease-in-out infinite; }
    @keyframes cloudFloat { 0%,100% { transform: translateX(0) } 50% { transform: translateX(-18px) } }
  </style>
</head>
<body class="h-screen w-screen overflow-hidden bg-black text-slate-100 antialiased">
  <!-- Obere Überschrift (schwarz) -->
  <div class="fixed inset-x-0 top-0 z-20 flex items-center justify-center px-4" style="padding-top: env(safe-area-inset-top);">
    <h1 class="text-lg font-bold text-black bg-white/70 px-3 py-1 rounded-xl">Beni`s Wetterstation</h1>
  </div>

  <main class="h-[100svh] w-screen">
    <svg id="houseScene" viewBox="0 0 900 540" preserveAspectRatio="xMidYMid slice" class="h-full w-full">
      <defs>
        <linearGradient id="skyGradDay" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stop-color="#cfeffd" />
          <stop offset="100%" stop-color="#eaf6ff" />
        </linearGradient>
        <linearGradient id="skyGradNight" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stop-color="#0b1d3a" />
          <stop offset="100%" stop-color="#0f2350" />
        </linearGradient>
        <linearGradient id="roofGrad" x1="0" y1="0" x2="1" y2="1">
          <stop offset="0%" stop-color="#f472b6" />
          <stop offset="100%" stop-color="#fb7185" />
        </linearGradient>
        <linearGradient id="wallGrad" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stop-color="#f8fafc" />
          <stop offset="100%" stop-color="#e2e8f0" />
        </linearGradient>
        <!-- Solarpanel-Gradient -->
        <linearGradient id="panelGrad" x1="0" y1="0" x2="1" y2="1">
          <stop offset="0%" stop-color="#60a5fa"/>
          <stop offset="100%" stop-color="#1e3a8a"/>
        </linearGradient>
        <filter id="shadow" x="-50%" y="-50%" width="200%" height="200%">
          <feDropShadow dx="0" dy="3" stdDeviation="6" flood-opacity="0.18"/>
        </filter>
      </defs>

      <!-- Himmel -->
      <rect id="sky" width="900" height="540" fill="url(#skyGradDay)" />

      <!-- Wiese -->
      <rect x="0" y="500" width="900" height="40" fill="#bbf7d0"/>

      <!-- Windrad -->
      <g id="windGroup" transform="translate(330,475)" filter="url(#shadow)">
        <line x1="0" y1="0" x2="0" y2="-90" stroke="#64748b" stroke-width="6"/>
        <g id="pinwheel" transform="translate(0,-90)">
          <circle r="6" fill="#64748b"/>
          <g id="vanes">
            <path d="M0,0 L0,-28 Q12,-22 16,-10 Z" fill="#94a3b8"/>
            <path d="M0,0 L28,0 Q22,12 10,16 Z" fill="#94a3b8"/>
            <path d="M0,0 L0,28 Q-12,22 -16,10 Z" fill="#94a3b8"/>
            <path d="M0,0 L-28,0 Q-22,-12 -10,-16 Z" fill="#94a3b8"/>
          </g>
        </g>
        <text id="windValue" x="-10" y="22" text-anchor="start" font-size="18" font-weight="700" fill="#0f172a">Wind: --</text>
      </g>

      <!-- Außenwerte (kompakt) -->
      <g id="outsidePanelLeft" transform="translate(300,165)" filter="url(#shadow)">
        <g id="windowTempOut" transform="translate(0,0)">
          <rect width="92" height="80" rx="14" ry="14" fill="#ffffff" stroke="#cbd5e1"/>
          <text id="tempOutValue" x="46" y="44" text-anchor="middle" font-size="20" font-weight="700" fill="#0f172a">-- °C</text>
          <text x="46" y="64" text-anchor="middle" font-size="12" fill="#475569">Außen Temp</text>
        </g>
        <g id="windowHumOut" transform="translate(0,90)">
          <rect width="92" height="80" rx="14" ry="14" fill="#ffffff" stroke="#cbd5e1"/>
          <text id="humOutValue" x="46" y="44" text-anchor="middle" font-size="20" font-weight="700" fill="#0f172a">-- %</text>
          <text x="46" y="64" text-anchor="middle" font-size="12" fill="#475569">Außen Feuchte</text>
        </g>
      </g>

      <!-- Haus (ohne Schornstein) + Solarpanel -->
      <g id="houseGroup" transform="translate(515,310) scale(0.85)" filter="url(#shadow)">
        <ellipse cx="0" cy="230" rx="140" ry="18" fill="#000" opacity="0.12" />
        <polygon points="-95,0 0,-100 95,0" fill="url(#roofGrad)" stroke="#f43f5e" stroke-width="2"/>
        <!-- Solarpanel auf der linken Dachfläche -->
        <g id="solar" transform="translate(-70,-10) rotate(-35)">
          <rect x="0" y="0" width="80" height="28" rx="4" fill="url(#panelGrad)" stroke="#0f172a" stroke-opacity=".25"/>
          <g opacity=".35" stroke="#93c5fd" stroke-width="1">
            <line x1="16" y1="4" x2="16" y2="24"/>
            <line x1="32" y1="4" x2="32" y2="24"/>
            <line x1="48" y1="4" x2="48" y2="24"/>
            <line x1="64" y1="4" x2="64" y2="24"/>
            <line x1="4" y1="10" x2="76" y2="10"/>
            <line x1="4" y1="18" x2="76" y2="18"/>
          </g>
        </g>
        <rect x="-90" y="0" width="180" height="220" rx="16" ry="16" fill="url(#wallGrad)" stroke="#cbd5e1" stroke-width="2"/>

        <!-- Innenwerte -->
        <g id="windowTempIn" transform="translate(-84,36)">
          <rect width="92" height="80" rx="14" ry="14" fill="#ffffff" stroke="#cbd5e1"/>
          <text id="tempInValue" x="46" y="44" text-anchor="middle" font-size="20" font-weight="700" fill="#0f172a">-- °C</text>
          <text x="46" y="64" text-anchor="middle" font-size="12" fill="#475569">Innen Temp</text>
        </g>
        <g id="windowHumIn" transform="translate(-84,130)">
          <rect width="92" height="80" rx="14" ry="14" fill="#ffffff" stroke="#cbd5e1"/>
          <text id="humInValue" x="46" y="44" text-anchor="middle" font-size="20" font-weight="700" fill="#0f172a">-- %</text>
          <text x="46" y="64" text-anchor="middle" font-size="12" fill="#475569">Innen Feuchte</text>
        </g>

        <!-- Tür -->
        <g id="door" transform="translate(26,48)">
          <rect width="56" height="160" rx="12" ry="12" fill="#f59e0b" stroke="#a16207"/>
          <circle cx="42" cy="82" r="4" fill="#7c2d12"/>
        </g>
      </g>

      <!-- Sonne & Wolke (verschachtelte Animationen, damit iOS die Position nicht überschreibt) -->
      <g id="sunGroup" transform="translate(375,100) scale(0.9)" filter="url(#shadow)">
        <g class="sunPulse">
          <circle r="45" fill="#ffd166" stroke="#d97706" stroke-width="2"/>
          <text id="uvValue" x="0" y="8" text-anchor="middle" font-size="20" font-weight="700" fill="#7c4a00">UV – --</text>
        </g>
      </g>
      <g id="moonGroup" transform="translate(375,100) scale(0.9)" opacity="0">
        <circle r="36" fill="#f1f5f9"/>
        <circle r="32" cx="8" cy="-5" fill="#0f2350" />
      </g>
      <g id="cloudGroup" transform="translate(500,105) scale(0.9)" filter="url(#shadow)">
        <g class="cloudFloat">
          <ellipse rx="58" ry="30" cx="0" cy="10" fill="#ffffff" stroke="#e2e8f0"/>
          <ellipse rx="45" ry="28" cx="-45" cy="22" fill="#ffffff" stroke="#e2e8f0"/>
          <ellipse rx="45" ry="28" cx="45" cy="22" fill="#ffffff" stroke="#e2e8f0"/>
          <text id="rainValue" x="0" y="65" text-anchor="middle" font-size="18" font-weight="600" fill="#334155">Regen: --</text>
        </g>
      </g>

      <!-- Timestamp unten -->
      <text id="timestamp" x="450" y="520" text-anchor="middle" font-size="14" fill="#334155">Letzte Aktualisierung: --</text>
    </svg>
  </main>

  <script>
    const CONFIG = {
      CHANNEL_ID: "3043993",
      READ_API_KEY: "5QKSO8HZ6BNPFTDE",
      FIELD_MAPPING: {
        tempInC:  1, // field1
        humInPct: 2, // field2
        tempOutC: 3, // field3
        humOutPct: 4, // field4
        uvIndex:  5  // field5
      },
      UV_NIGHT_THRESHOLD: 0.1,
      DECIMALS_TEMP: 1,
      DECIMALS_HUM: 0
    };

    async function fetchFieldLast(fieldNo){
      // Robust: hole den letzten Wert UNABHÄNGIG von den anderen Feldern
      const base = `https://api.thingspeak.com/channels/${CONFIG.CHANNEL_ID}/fields/${fieldNo}`;
      const q = `api_key=${encodeURIComponent(CONFIG.READ_API_KEY)}&results=1`;
      try {
        // prefer JSON list (stabil auf allen Plänen)
        const url = `${base}.json?${q}`;
        const r = await fetch(url);
        if(!r.ok) throw new Error(`HTTP ${r.status}`);
        const data = await r.json();
        if(data && data.feeds && data.feeds.length){
          const feed = data.feeds[data.feeds.length-1];
          const key = `field${fieldNo}`;
          return feed[key];
        }
      } catch(e){ console.warn('fetchFieldLast', fieldNo, e); }
      return null;
    }

    async function fetchAll(){
      const F = CONFIG.FIELD_MAPPING;
      const [tIn, hIn, tOut, hOut, uv] = await Promise.all([
        fetchFieldLast(F.tempInC),
        fetchFieldLast(F.humInPct),
        fetchFieldLast(F.tempOutC),
        fetchFieldLast(F.humOutPct),
        fetchFieldLast(F.uvIndex),
      ]);
      applyValues({ tIn, hIn, tOut, hOut, uv });
    }

    function num(x){ const v = parseFloat(x); return Number.isFinite(v)? v : NaN; }

    function applyValues({ tIn, hIn, tOut, hOut, uv }){
      const n_tIn  = num(tIn);
      const n_hIn  = num(hIn);
      const n_tOut = num(tOut);
      const n_hOut = num(hOut);
      const n_uv   = num(uv);

      document.getElementById('tempInValue').textContent  = Number.isFinite(n_tIn)  ? `${n_tIn.toFixed(CONFIG.DECIMALS_TEMP)} °C` : '-- °C';
      document.getElementById('humInValue').textContent   = Number.isFinite(n_hIn)  ? `${n_hIn.toFixed(CONFIG.DECIMALS_HUM)} %`  : '-- %';
      document.getElementById('tempOutValue').textContent = Number.isFinite(n_tOut) ? `${n_tOut.toFixed(CONFIG.DECIMALS_TEMP)} °C` : '-- °C';
      document.getElementById('humOutValue').textContent  = Number.isFinite(n_hOut) ? `${n_hOut.toFixed(CONFIG.DECIMALS_HUM)} %`  : '-- %';
      document.getElementById('uvValue').textContent      = Number.isFinite(n_uv)   ? `UV – ${n_uv.toFixed(1)}` : 'UV – --';

      const sky  = document.getElementById('sky');
      const sun  = document.getElementById('sunGroup');
      const moon = document.getElementById('moonGroup');
      const isNight = Number.isFinite(n_uv) ? (n_uv <= CONFIG.UV_NIGHT_THRESHOLD) : false;
      if(isNight){
        sky.setAttribute('fill','url(#skyGradNight)');
        if(sun)  sun.setAttribute('opacity','0');
        if(moon) moon.setAttribute('opacity','1');
      } else {
        sky.setAttribute('fill','url(#skyGradDay)');
        if(sun)  sun.setAttribute('opacity','1');
        if(moon) moon.setAttribute('opacity','0');
      }

      // Zeitstempel aus dem Moment des Abrufs
      document.getElementById('timestamp').textContent = `Letzte Aktualisierung: ${new Date().toLocaleString()}`;
    }

    fetchAll();
    setInterval(fetchAll, 60000);
  </script>
</body>
</html>
