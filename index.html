<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Benis Wetterstation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <style>
    :root { --bg:#0f172a; --card:#111827; --fg:#e5e7eb; --muted:#93a4b8; --maxw:480px; --stale:#facc15; }
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--fg);-webkit-text-size-adjust:100%;padding:env(safe-area-inset-top) 12px env(safe-area-inset-bottom)}
    header{position:sticky;top:0;z-index:10;backdrop-filter:blur(8px);background:rgba(15,23,42,.7);border-bottom:1px solid rgba(148,163,184,.2);padding:10px 8px;display:flex;justify-content:space-between;align-items:center;gap:10px}
    h1{margin:0;font-size:clamp(20px,4.8vw,26px)}
    #lastUpdate{color:var(--muted);font-size:12px}
    main{margin:12px auto 40px;max-width:var(--maxw)}
    .grid{display:grid;gap:12px}
    .card{background:var(--card);border:1px solid rgba(148,163,184,.18);border-radius:16px;padding:14px;box-shadow:0 8px 20px rgba(0,0,0,.25);transition:border-color .2s ease}
    .card.stale{border-color:rgba(250,204,21,.6)}
    .row{display:flex;align-items:center;gap:12px}
    .iconWrap{width:48px;height:48px;display:grid;place-items:center;flex-shrink:0;border-radius:14px;border:1px solid rgba(148,163,184,.25);background:radial-gradient(500px 200px at -10% -50%,rgba(96,165,250,.20),transparent),#0b1220}
    .iconWrap svg{width:28px;height:28px;color:var(--fg)}
    .title{font-size:16px;color:var(--muted);margin:0}
    .bigValue{font-size:clamp(40px,10vw,56px);font-weight:800;line-height:1.05;margin:2px 0 2px}
    .card.stale .bigValue{color:var(--stale)}
    .unit{font-size:18px;color:var(--muted);margin-left:6px;font-weight:600}
    .mmRow{display:flex;gap:10px;align-items:center;font-size:14px;color:var(--muted)}
    .mmRow .label{opacity:.9}
    .error{color:#fecaca;font-size:13px;margin-top:8px;display:none}
  </style>
</head>
<body>
  <header>
    <h1>Benis Wetterstation</h1>
    <div id="lastUpdate">Letztes Update: –</div>
  </header>

  <main>
    <section id="cards" class="grid"></section>
    <div id="errorGlobal" class="error" style="display:none;">Konnte Daten nicht laden.</div>
  </main>

  <script>
    // ====== CONFIG (Mehrere Channels, nur IST-Werte) ======
    const CONFIG = {
      refreshSec: 60,
      staleMinutes: 60, // ab wie vielen Minuten gelb markieren
      channels: [
        {
          id: 3043993,
          readKey: "5QKSO8HZ6BNPFTDE",
          fields: [
            { n:1, title:"Temperatur Wohnzimmer", unit:"°C", digits:1, icon:"thermo" },
            { n:2, title:"Luftfeuchte Wohnzimmer", unit:"%", digits:0, icon:"drop" },
            { n:3, title:"Temperatur Außen Wiesloch", unit:"°C", digits:1, icon:"thermo" },
            { n:4, title:"Luftfeuchte Außen Wiesloch", unit:"%", digits:0, icon:"drop" },
            { n:5, title:"UV‑Index", unit:"", digits:1, icon:"sun" }
          ]
        },
        {
          id: 3094234,
          readKey: "OZU6XCJ29SCQTLQT",
          fields: [
            { n:1, title:"Außentemperatur Oberderdingen", unit:"°C", digits:1, icon:"thermo" },
            { n:2, title:"Außentemperatur Flehingen", unit:"°C", digits:1, icon:"thermo" },
            { n:3, title:"Temperatur Büro Arbeit", unit:"°C", digits:1, icon:"thermo" }
          ]
        },
        {
          id: 3089969,
          readKey: "G93FDQPXIJ75KSOR",
          fields: [
            { n:1, title:"Schwimmerbecken Filplebad", unit:"°C", digits:1, icon:"thermo" },
            { n:2, title:"Kinderplanschbecken Filplebad", unit:"°C", digits:1, icon:"thermo" },
            { n:3, title:"Wassertemperatur NaturErlebnisBad", unit:"°C", digits:1, icon:"thermo" }
          ]
        }
      ]
    };

    // ====== State ======
    const STATE = { lastAt: {}, today: todayKey() };

    // ====== Helpers ======
    const $ = (q, el=document) => el.querySelector(q);
    function fmt(n, digits=1){ const x=Number(n); return Number.isFinite(x)? x.toLocaleString("de-DE",{maximumFractionDigits:digits,minimumFractionDigits:digits}) : "–"; }
    function labelFromISO(iso){ if(!iso) return "–"; const d=new Date(iso); const dd=String(d.getDate()).padStart(2,"0"); const mm=String(d.getMonth()+1).padStart(2,"0"); const hh=String(d.getHours()).padStart(2,"0"); const mi=String(d.getMinutes()).padStart(2,"0"); return `${dd}.${mm} ${hh}:${mi}`; }
    function iconSVG(name){
      switch(name){
        case 'thermo': return `<svg viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='1.7' stroke-linecap='round' stroke-linejoin='round'><path d='M14 14.76V5a2 2 0 0 0-4 0v9.76a4 4 0 1 0 4 0Z'/><path d='M10 9h4'/></svg>`;
        case 'drop': return `<svg viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='1.7' stroke-linecap='round' stroke-linejoin='round'><path d='M12 2s6 6 6 10a6 6 0 0 1-12 0C6 8 12 2 12 2Z'/><path d='M12 13a2 2 0 0 1-2-2'/></svg>`;
        case 'sun': return `<svg viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='1.7' stroke-linecap='round' stroke-linejoin='round'><circle cx='12' cy='12' r='4'/><path d='M12 2v2m0 16v2m10-10h-2M4 12H2m15.5-6.5-1.4 1.4M8 17.9l-1.4 1.4m0-13.8L8 6.9m8.1 10.1 1.4 1.4'/></svg>`;
        default: return `<svg viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='1.7'><circle cx='12' cy='12' r='9'/></svg>`;
      }
    }

    // ====== Min/Max – pro Tag in localStorage ======
    const STORAGE_PREFIX = 'benisMM';
    function todayKey(){ const d=new Date(); const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const da=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${da}`; }
    function mmKey(channelId, fieldN){ return `${STORAGE_PREFIX}:${channelId}:f${fieldN}:${todayKey()}`; }
    function readMM(channelId, n){ try{ const raw=localStorage.getItem(mmKey(channelId,n)); return raw? JSON.parse(raw) : null; } catch{ return null; } }
    function writeMM(channelId, n, mm){ try{ localStorage.setItem(mmKey(channelId,n), JSON.stringify(mm)); } catch{} }
    function updateMM(channelId, n, val){ if(!Number.isFinite(val)) return; const cur = readMM(channelId,n) || { min: val, max: val }; if (val < cur.min) cur.min = val; if (val > cur.max) cur.max = val; writeMM(channelId,n,cur); showMM(channelId,n); }
    function showMM(channelId, n, digits){ const mm = readMM(channelId,n); const minEl = document.getElementById(`min-c${channelId}-f${n}`); const maxEl = document.getElementById(`max-c${channelId}-f${n}`); if(!minEl||!maxEl) return; if(mm){ minEl.textContent = fmt(mm.min, digits); maxEl.textContent = fmt(mm.max, digits); } else { minEl.textContent='–'; maxEl.textContent='–'; } }

    // ====== UI bauen ======
    const cardsEl = document.getElementById('cards');
    function buildCard(ch, field){
      const card = document.createElement('article');
      card.className='card';
      card.id=`card-c${ch.id}-f${field.n}`;
      card.innerHTML = `
        <div class='row'>
          <div class='iconWrap'>${iconSVG(field.icon)}</div>
          <div style='flex:1;'>
            <p class='title'>${field.title}</p>
            <div class='bigValue'><span id='val-c${ch.id}-f${field.n}'>–</span><span class='unit'> ${field.unit}</span></div>
            <div class='mmRow'><span class='label'>Min</span> <span id='min-c${ch.id}-f${field.n}'>–</span> <span class='label'>• Max</span> <span id='max-c${ch.id}-f${field.n}'>–</span></div>
          </div>
        </div>`;
      cardsEl.appendChild(card);
      showMM(ch.id, field.n, field.digits ?? 1);
    }
    CONFIG.channels.forEach(ch => ch.fields.forEach(f => buildCard(ch, f)));

    // ====== Feld laden: /channels/{id}/fields/{n}/last.json ======
    async function loadField(ch, f){
      const url = new URL(`https://api.thingspeak.com/channels/${ch.id}/fields/${f.n}/last.json`);
      if (ch.readKey) url.searchParams.set('api_key', ch.readKey);
      try{
        const res = await fetch(url.toString(), { cache:'no-store' });
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const obj = await res.json();

        const createdAt = obj.created_at || null;
        const raw = obj[`field${f.n}`];
        const card = document.getElementById(`card-c${ch.id}-f${f.n}`);

        // Stale-Färbung: gelb, wenn älter als CONFIG.staleMinutes
        if (createdAt) {
          const ageMin = (Date.now() - new Date(createdAt).getTime())/60000;
          if (ageMin > CONFIG.staleMinutes) card.classList.add('stale'); else card.classList.remove('stale');
        }

        const stateKey = `${ch.id}-${f.n}`;
        // nur updaten, wenn neuer Zeitstempel als bisher
        if (!STATE.lastAt[stateKey] || createdAt !== STATE.lastAt[stateKey]) {
          const num = raw==null ? NaN : parseFloat(raw);
          const text = Number.isFinite(num) ? fmt(num, f.digits ?? 1) : (raw ?? '–');
          document.getElementById(`val-c${ch.id}-f${f.n}`).textContent = text;
          STATE.lastAt[stateKey] = createdAt;
          if (Number.isFinite(num)) updateMM(ch.id, f.n, num);
        }

        document.getElementById('errorGlobal').style.display='none';
        return createdAt;
      }catch(e){
        const eg=document.getElementById('errorGlobal');
        eg.textContent=`Konnte Daten nicht laden: ${e.message}`;
        eg.style.display='block';
        return null;
      }
    }

    async function loadAll(){
      // Tageswechsel erkennen: Anzeige der Min/Max leeren
      const tk = todayKey();
      if (tk !== STATE.today) {
        STATE.today = tk;
        // Alle Min/Max-Anzeigen auf heutigen Speicherstand setzen (i.d.R. "–")
        CONFIG.channels.forEach(ch => ch.fields.forEach(f => showMM(ch.id, f.n, f.digits ?? 1)));
      }

      const timeMatrix = await Promise.all(
        CONFIG.channels.map(ch => Promise.all(ch.fields.map(f => loadField(ch,f))))
      );
      const times = timeMatrix.flat().filter(Boolean).map(t => new Date(t).getTime());
      if (times.length) {
        const maxTs = Math.max(...times);
        document.getElementById('lastUpdate').textContent = `Letztes Update: ${labelFromISO(new Date(maxTs).toISOString())}`;
      }
    }

    // ====== Initial laden + Auto-Refresh ======
    loadAll();
    setInterval(loadAll, CONFIG.refreshSec*1000);
  </script>
</body>
</html>
