<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Haus-Dashboard</title>
  <!-- Tailwind via CDN (optional). Entferne die nächste Zeile, wenn du kein CDN willst. -->
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="description" content="Visualisiertes Haus-Dashboard mit UV, Regen, Temperatur und Luftfeuchte, gespeist von ThingSpeak." />
  <style>
    /* Kleines Polishing, falls Tailwind entfernt wird */
    .metric { font-variant-numeric: tabular-nums; }
    .blink { animation: blink 1.2s linear infinite; }
    @keyframes blink { 50% { opacity: .4 } }
  </style>
</head>
<body class="min-h-screen bg-sky-50 text-slate-800 antialiased">
  <main class="max-w-5xl mx-auto p-4 md:p-8">
    <header class="mb-6 flex items-center justify-between gap-4">
      <h1 class="text-2xl md:text-3xl font-bold">Mein Haus-Dashboard</h1>
      <button id="refreshBtn" class="px-4 py-2 rounded-2xl bg-sky-600 text-white hover:bg-sky-700">Aktualisieren</button>
    </header>

    <!--
      🔧 KONFIGURATION
      Trage hier deine ThingSpeak-Infos ein und mappe Felder -> Datenbedeutung.
      - CHANNEL_ID:      numerische ID deines Channels
      - READ_API_KEY:    optional, falls Channel privat ist
      - FIELD_MAPPING:   ordne deine Felder zu (z.B. field1 = Temperatur).
    -->
    <script>
      const CONFIG = {
        CHANNEL_ID: "YOUR_CHANNEL_ID_HERE",
        READ_API_KEY: "YOUR_READ_API_KEY_HERE", // leer lassen, wenn öffentlich
        FIELD_MAPPING: {
          temperatureC: "field1", // Temperatur in °C
          humidityPct:  "field2", // Luftfeuchte in %
          uvIndex:      "field3", // UV-Index (z.B. 0..11+)
          rainFlag:     "field4", // 0/1 oder true/false
        },
        // Optionales Tuning
        NUM_RESULTS: 1,              // wie viele letzte Messungen holen
        DECIMALS_TEMP: 1,
        DECIMALS_HUM: 0,
      };
    </script>

    <!--
      🏠 Illustration als skalierbare SVG
      - Wir arbeiten mit IDs, damit JS gezielt Text/Icons austauschen kann.
    -->
    <section class="bg-white rounded-3xl shadow p-4 md:p-6">
      <div class="grid md:grid-cols-2 gap-6 items-center">
        <!-- SVG-Bild -->
        <div class="w-full">
          <svg id="houseScene" viewBox="0 0 800 500" class="w-full h-auto">
            <!-- Himmel -->
            <defs>
              <linearGradient id="skyGrad" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0%" stop-color="#cfeffd" />
                <stop offset="100%" stop-color="#eaf6ff" />
              </linearGradient>
              <filter id="shadow" x="-50%" y="-50%" width="200%" height="200%">
                <feDropShadow dx="0" dy="3" stdDeviation="6" flood-opacity="0.2"/>
              </filter>
            </defs>
            <rect x="0" y="0" width="800" height="500" fill="url(#skyGrad)"/>

            <!-- Sonne (oben links) -->
            <g id="sunGroup" transform="translate(110,110)" filter="url(#shadow)">
              <circle r="50" fill="#ffd166" />
              <text id="uvValue" x="0" y="6" text-anchor="middle" font-size="20" font-weight="700" fill="#7c4a00">UV – --</text>
            </g>

            <!-- Wolke (oben rechts) -->
            <g id="cloudGroup" transform="translate(650,120)" filter="url(#shadow)">
              <ellipse rx="60" ry="32" cx="0" cy="10" fill="#ffffff"/>
              <ellipse rx="45" ry="28" cx="-45" cy="20" fill="#ffffff"/>
              <ellipse rx="45" ry="28" cx="45" cy="20" fill="#ffffff"/>
              <text id="rainValue" x="0" y="58" text-anchor="middle" font-size="18" font-weight="600" fill="#334155">Regen: --</text>
            </g>

            <!-- Wiese -->
            <rect x="0" y="410" width="800" height="90" fill="#bbf7d0"/>

            <!-- Hauskörper -->
            <g id="houseGroup" transform="translate(300,240)" filter="url(#shadow)">
              <rect x="-120" y="0" width="240" height="140" fill="#f1f5f9" stroke="#cbd5e1" stroke-width="2"/>
              <polygon points="-140,0 0,-90 140,0" fill="#e2e8f0" stroke="#cbd5e1" stroke-width="2"/>

              <!-- Fenster links (Temp) -->
              <g id="windowTemp" transform="translate(-70,35)">
                <rect width="80" height="60" fill="#ffffff" stroke="#cbd5e1"/>
                <text id="tempValue" x="40" y="35" text-anchor="middle" font-size="20" font-weight="700" fill="#0f172a">-- °C</text>
                <text x="40" y="55" text-anchor="middle" font-size="12" fill="#475569">Temperatur</text>
              </g>

              <!-- Fenster rechts (Feuchte) -->
              <g id="windowHum" transform="translate( -10,35)">
                <rect width="80" height="60" fill="#ffffff" stroke="#cbd5e1"/>
                <text id="humValue" x="40" y="35" text-anchor="middle" font-size="20" font-weight="700" fill="#0f172a">-- %</text>
                <text x="40" y="55" text-anchor="middle" font-size="12" fill="#475569">Luftfeuchte</text>
              </g>

              <!-- Tür (Zeit) -->
              <g id="door" transform="translate(70,30)">
                <rect width="50" height="110" fill="#eab308" stroke="#a16207"/>
                <circle cx="42" cy="58" r="3" fill="#7c2d12"/>
              </g>
            </g>

            <!-- Zeitstempel unten -->
            <text id="timestamp" x="400" y="480" text-anchor="middle" font-size="14" fill="#334155">Letzte Aktualisierung: --</text>
          </svg>
        </div>

        <!-- Werte + Status -->
        <div class="space-y-4">
          <div class="grid grid-cols-2 gap-4">
            <div class="rounded-2xl border border-slate-200 p-4 bg-white">
              <div class="text-sm text-slate-500">Temperatur</div>
              <div id="tempCard" class="metric text-3xl font-bold">-- °C</div>
            </div>
            <div class="rounded-2xl border border-slate-200 p-4 bg-white">
              <div class="text-sm text-slate-500">Luftfeuchte</div>
              <div id="humCard" class="metric text-3xl font-bold">-- %</div>
            </div>
            <div class="rounded-2xl border border-slate-200 p-4 bg-white">
              <div class="text-sm text-slate-500">UV-Index</div>
              <div id="uvCard" class="metric text-3xl font-bold">--</div>
            </div>
            <div class="rounded-2xl border border-slate-200 p-4 bg-white">
              <div class="text-sm text-slate-500">Regen</div>
              <div id="rainCard" class="metric text-3xl font-bold">--</div>
            </div>
          </div>

          <div class="text-sm text-slate-500">Quelle: ThingSpeak</div>
          <div id="status" class="text-sm"></div>
        </div>
      </div>
    </section>

    <footer class="mt-8 text-xs text-slate-500">
      Tipp: Das SVG ist frei skalierbar. Du kannst Gruppen/IDs umbenennen oder weitere Elemente einbauen (z.B. Windfahne, Schneeflocke, etc.).
    </footer>
  </main>

  <script>
    async function fetchFromThingSpeak() {
      const base = `https://api.thingspeak.com/channels/${CONFIG.CHANNEL_ID}/feeds.json`;
      const params = new URLSearchParams({ results: String(CONFIG.NUM_RESULTS) });
      if (CONFIG.READ_API_KEY && CONFIG.READ_API_KEY !== "YOUR_READ_API_KEY_HERE") {
        params.set("api_key", CONFIG.READ_API_KEY);
      }
      const url = `${base}?${params.toString()}`;
      const statusEl = document.getElementById('status');
      statusEl.textContent = 'Hole Daten…';
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        if (!data.feeds || !data.feeds.length) throw new Error('Keine Daten gefunden');
        const latest = data.feeds[data.feeds.length - 1];
        applyData(latest, data.channel);
        statusEl.textContent = 'Aktualisiert';
      } catch (err) {
        console.error(err);
        statusEl.innerHTML = `<span class="text-red-600">Fehler: ${err.message}</span>`;
      }
    }

    function applyData(feed, channelMeta) {
      const F = CONFIG.FIELD_MAPPING;
      // Rohwerte lesen und in Zahlen umwandeln, falls möglich
      const temp = parseFloat(feed[F.temperatureC]);
      const hum  = parseFloat(feed[F.humidityPct]);
      const uv   = parseFloat(feed[F.uvIndex]);
      const rainRaw = feed[F.rainFlag];

      const rain = typeof rainRaw === 'string'
        ? (rainRaw.trim() === '1' || rainRaw.trim().toLowerCase() === 'true')
        : !!rainRaw;

      // Formatierung
      const tempTxt = isFinite(temp) ? `${temp.toFixed(CONFIG.DECIMALS_TEMP)} °C` : '-- °C';
      const humTxt  = isFinite(hum)  ? `${hum.toFixed(CONFIG.DECIMALS_HUM)} %` : '-- %';
      const uvTxt   = isFinite(uv)   ? `${uv.toFixed(1)}` : '--';
      const rainTxt = rain ? 'Ja' : 'Nein';

      // DOM Updates – Karten
      document.getElementById('tempCard').textContent = tempTxt;
      document.getElementById('humCard').textContent = humTxt;
      document.getElementById('uvCard').textContent = uvTxt;
      document.getElementById('rainCard').textContent = rainTxt;

      // DOM Updates – SVG
      document.getElementById('tempValue').textContent = tempTxt;
      document.getElementById('humValue').textContent = humTxt;
      document.getElementById('uvValue').textContent = `UV – ${uvTxt}`;
      document.getElementById('rainValue').textContent = `Regen: ${rainTxt}`;

      // Optional: Sonne blinzeln bei hohem UV
      const sun = document.getElementById('sunGroup');
      if (isFinite(uv) && uv >= 6) sun.classList.add('blink'); else sun.classList.remove('blink');

      // Zeitstempel
      const tsEl = document.getElementById('timestamp');
      const ts   = feed.created_at || new Date().toISOString();
      const dt   = new Date(ts);
      tsEl.textContent = `Letzte Aktualisierung: ${dt.toLocaleString()}`;

      // Barrierefreiheit: Titel/Aria-Labels setzen
      document.getElementById('houseScene').setAttribute('aria-label', `Werte: Temperatur ${tempTxt}, Luftfeuchte ${humTxt}, UV ${uvTxt}, Regen ${rainTxt}`);
    }

    // Auto-Refresh alle 60s (anpassbar)
    let interval = setInterval(fetchFromThingSpeak, 60000);
    document.getElementById('refreshBtn').addEventListener('click', fetchFromThingSpeak);

    // Initialer Abruf
    fetchFromThingSpeak();
  </script>
</body>
</html>
