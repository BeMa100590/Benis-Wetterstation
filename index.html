<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Haus-Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="description" content="Visualisiertes Haus-Dashboard mit Innen-/Außenwerten (Temp, Feuchte) plus UV, Regen und Wind, gespeist von ThingSpeak." />
  <style>
    .metric { font-variant-numeric: tabular-nums; }
    .blink { animation: blink 1.2s linear infinite; }
    @keyframes blink { 50% { opacity: .4 } }
    .spin {
      animation-name: spin;
      animation-iteration-count: infinite;
      animation-timing-function: linear;
    }
    @keyframes spin { from { transform: rotate(0deg) } to { transform: rotate(360deg) } }
  </style>
</head>
<body class="min-h-screen bg-sky-50 text-slate-800 antialiased">
  <main class="max-w-5xl mx-auto p-4 md:p-8">
    <header class="mb-4 md:mb-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
      <h1 class="text-xl sm:text-2xl md:text-3xl font-bold leading-tight">Mein Haus-Dashboard</h1>
      <div class="flex gap-2 w-full sm:w-auto">
        <button id="refreshBtn" class="flex-1 sm:flex-none px-4 py-2 rounded-2xl bg-sky-600 text-white hover:bg-sky-700 active:scale-[.99]">Aktualisieren</button>
      </div>
    </header>

    <script>
      const CONFIG = {
        CHANNEL_ID: "YOUR_CHANNEL_ID_HERE",
        READ_API_KEY: "YOUR_READ_API_KEY_HERE", // leer lassen, wenn öffentlich
        FIELD_MAPPING: {
          // Außenwerte
          tempOutC:  "field1",   // Außentemperatur °C
          humOutPct: "field2",   // Außenfeuchte %
          // Innenwerte
          tempInC:   "field3",   // Innentemperatur °C
          humInPct:  "field4",   // Innenfeuchte %
          // Zusätzliche Sensoren (optional)
          uvIndex:   "field5",   // UV-Index
          rainFlag:  "field6",   // 0/1 oder true/false
          windMs:    "field7",   // Windgeschwindigkeit in m/s
        },
        NUM_RESULTS: 1,
        DECIMALS_TEMP: 1,
        DECIMALS_HUM: 0,
        DECIMALS_WIND: 1,
      };
    </script>

    <section class="bg-white rounded-3xl shadow p-3 sm:p-4 md:p-6">
      <div class="grid gap-4 md:grid-cols-2 items-center">
        <!-- SVG-Bild -->
        <div class="w-full">
          <svg id="houseScene" viewBox="0 0 880 520" class="w-full h-auto">
            <!-- Himmel -->
            <defs>
              <linearGradient id="skyGrad" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0%" stop-color="#cfeffd" />
                <stop offset="100%" stop-color="#eaf6ff" />
              </linearGradient>
              <linearGradient id="roofGrad" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0%" stop-color="#f472b6" />
                <stop offset="100%" stop-color="#fb7185" />
              </linearGradient>
              <linearGradient id="wallGrad" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0%" stop-color="#f8fafc" />
                <stop offset="100%" stop-color="#e2e8f0" />
              </linearGradient>
              <filter id="shadow" x="-50%" y="-50%" width="200%" height="200%">
                <feDropShadow dx="0" dy="3" stdDeviation="6" flood-opacity="0.18"/>
              </filter>
            </defs>
            <rect x="0" y="0" width="880" height="520" fill="url(#skyGrad)"/>

            <!-- Sonne oben links mit UV -->
            <g id="sunGroup" transform="translate(120,110)" filter="url(#shadow)">
              <circle r="56" fill="#ffd166" />
              <text id="uvValue" x="0" y="8" text-anchor="middle" font-size="22" font-weight="700" fill="#7c4a00">UV – --</text>
            </g>

            <!-- Wolken oben rechts mit Regenanzeige -->
            <g id="cloudGroup" transform="translate(690,120)" filter="url(#shadow)">
              <ellipse rx="64" ry="34" cx="0" cy="10" fill="#ffffff"/>
              <ellipse rx="50" ry="30" cx="-50" cy="22" fill="#ffffff"/>
              <ellipse rx="50" ry="30" cx="50" cy="22" fill="#ffffff"/>
              <text id="rainValue" x="0" y="65" text-anchor="middle" font-size="18" font-weight="600" fill="#334155">Regen: --</text>
            </g>

            <!-- Wiese -->
            <rect x="0" y="430" width="880" height="90" fill="#bbf7d0"/>

            <!-- Wind-Pinwheel links -->
            <g id="windGroup" transform="translate(80,390)" filter="url(#shadow)">
              <line x1="0" y1="0" x2="0" y2="-80" stroke="#64748b" stroke-width="6"/>
              <g id="pinwheel" transform="translate(0,-80)">
                <circle r="6" fill="#64748b"/>
                <g id="vanes">
                  <path d="M0,0 L0,-28 Q12,-22 16,-10 Z" fill="#94a3b8"/>
                  <path d="M0,0 L28,0 Q22,12 10,16 Z" fill="#94a3b8"/>
                  <path d="M0,0 L0,28 Q-12,22 -16,10 Z" fill="#94a3b8"/>
                  <path d="M0,0 L-28,0 Q-22,-12 -10,-16 Z" fill="#94a3b8"/>
                </g>
              </g>
              <text id="windValue" x="-10" y="20" text-anchor="start" font-size="18" font-weight="700" fill="#0f172a">Wind: --</text>
            </g>

            <!-- Haus -->
            <g id="houseGroup" transform="translate(360,250)" filter="url(#shadow)">
              <!-- Dach -->
              <polygon points="-170,0 0,-110 170,0" fill="url(#roofGrad)" stroke="#f43f5e" stroke-width="2"/>
              <!-- Kamin -->
              <rect x="70" y="-110" width="24" height="46" fill="#ef4444" stroke="#b91c1c"/>
              <circle cx="82" cy="-120" r="5" fill="#e5e7eb"/>
              <circle cx="88" cy="-128" r="7" fill="#e5e7eb" opacity=".7"/>

              <!-- Wände (leicht abgerundet) -->
              <rect x="-150" y="0" width="300" height="160" rx="14" ry="14" fill="url(#wallGrad)" stroke="#cbd5e1" stroke-width="2"/>

              <!-- Innenwerte: zwei runde Fenster -->
              <g id="windowTempIn" transform="translate(-90,40)">
                <rect width="96" height="72" rx="14" ry="14" fill="#ffffff" stroke="#cbd5e1"/>
                <text id="tempInValue" x="48" y="40" text-anchor="middle" font-size="20" font-weight="700" fill="#0f172a">-- °C</text>
                <text x="48" y="60" text-anchor="middle" font-size="12" fill="#475569">Innen Temp</text>
              </g>

              <g id="windowHumIn" transform="translate(10,40)">
                <rect width="96" height="72" rx="14" ry="14" fill="#ffffff" stroke="#cbd5e1"/>
                <text id="humInValue" x="48" y="40" text-anchor="middle" font-size="20" font-weight="700" fill="#0f172a">-- %</text>
                <text x="48" y="60" text-anchor="middle" font-size="12" fill="#475569">Innen Feuchte</text>
              </g>

              <!-- Tür -->
              <g id="door" transform="translate(120,34)">
                <rect width="56" height="116" rx="10" ry="10" fill="#f59e0b" stroke="#a16207"/>
                <circle cx="44" cy="60" r="3.5" fill="#7c2d12"/>
              </g>

              <!-- Außenwerte: Wand-Kästchen außen rechts -->
              <g id="outsidePanel" transform="translate(170,30)">
                <rect width="120" height="120" rx="16" ry="16" fill="#ffffff" stroke="#cbd5e1"/>
                <text id="tempOutValue" x="60" y="48" text-anchor="middle" font-size="20" font-weight="700" fill="#0f172a">-- °C</text>
                <text x="60" y="66" text-anchor="middle" font-size="12" fill="#475569">Außen Temp</text>
                <text id="humOutValue" x="60" y="98" text-anchor="middle" font-size="20" font-weight="700" fill="#0f172a">-- %</text>
                <text x="60" y="116" text-anchor="middle" font-size="12" fill="#475569">Außen Feuchte</text>
              </g>
            </g>

            <!-- Zeitstempel -->
            <text id="timestamp" x="440" y="500" text-anchor="middle" font-size="14" fill="#334155">Letzte Aktualisierung: --</text>
          </svg>
        </div>

        <!-- Werte + Status (mobilfreundlich – große, runde Karten) -->
        <div class="space-y-3">
          <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
            <div class="rounded-3xl border border-slate-200 p-3 sm:p-4 bg-white">
              <div class="text-xs sm:text-sm text-slate-500">Innen Temp</div>
              <div id="tempInCard" class="metric text-2xl sm:text-3xl font-bold">-- °C</div>
            </div>
            <div class="rounded-3xl border border-slate-200 p-3 sm:p-4 bg-white">
              <div class="text-xs sm:text-sm text-slate-500">Innen Feuchte</div>
              <div id="humInCard" class="metric text-2xl sm:text-3xl font-bold">-- %</div>
            </div>
            <div class="rounded-3xl border border-slate-200 p-3 sm:p-4 bg-white">
              <div class="text-xs sm:text-sm text-slate-500">Außen Temp</div>
              <div id="tempOutCard" class="metric text-2xl sm:text-3xl font-bold">-- °C</div>
            </div>
            <div class="rounded-3xl border border-slate-200 p-3 sm:p-4 bg-white">
              <div class="text-xs sm:text-sm text-slate-500">Außen Feuchte</div>
              <div id="humOutCard" class="metric text-2xl sm:text-3xl font-bold">-- %</div>
            </div>
            <div class="rounded-3xl border border-slate-200 p-3 sm:p-4 bg-white">
              <div class="text-xs sm:text-sm text-slate-500">Wind</div>
              <div id="windCard" class="metric text-2xl sm:text-3xl font-bold">-- m/s</div>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div class="rounded-3xl border border-slate-200 p-3 sm:p-4 bg-white">
              <div class="text-xs sm:text-sm text-slate-500">UV-Index</div>
              <div id="uvCard" class="metric text-2xl sm:text-3xl font-bold">--</div>
            </div>
            <div class="rounded-3xl border border-slate-200 p-3 sm:p-4 bg-white">
              <div class="text-xs sm:text-sm text-slate-500">Regen</div>
              <div id="rainCard" class="metric text-2xl sm:text-3xl font-bold">--</div>
            </div>
          </div>

          <div class="text-xs sm:text-sm text-slate-500">Quelle: ThingSpeak</div>
          <div id="status" class="text-sm"></div>
        </div>
      </div>
    </section>

    <footer class="mt-6 text-xs text-slate-500">
      Optimiert für Smartphones: größere Touch-Ziele, kompakte Karten, skalierbares SVG. Du kannst die Feld-Zuordnung in <code>CONFIG.FIELD_MAPPING</code> an deine Channel-Felder anpassen.
    </footer>
  </main>

  <script>
    async function fetchFromThingSpeak() {
      const base = `https://api.thingspeak.com/channels/${CONFIG.CHANNEL_ID}/feeds.json`;
      const params = new URLSearchParams({ results: String(CONFIG.NUM_RESULTS) });
      if (CONFIG.READ_API_KEY && CONFIG.READ_API_KEY !== "YOUR_READ_API_KEY_HERE") {
        params.set("api_key", CONFIG.READ_API_KEY);
      }
      const url = `${base}?${params.toString()}`;
      const statusEl = document.getElementById('status');
      statusEl.textContent = 'Hole Daten…';
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        if (!data.feeds || !data.feeds.length) throw new Error('Keine Daten gefunden');
        const latest = data.feeds[data.feeds.length - 1];
        applyData(latest, data.channel);
        statusEl.textContent = 'Aktualisiert';
      } catch (err) {
        console.error(err);
        statusEl.innerHTML = `<span class="text-red-600">Fehler: ${err.message}</span>`;
      }
    }

    function n(x) { const v = parseFloat(x); return isFinite(v) ? v : NaN; }

    function applyData(feed) {
      const F = CONFIG.FIELD_MAPPING;
      const tempIn  = n(feed[F.tempInC]);
      const humIn   = n(feed[F.humInPct]);
      const tempOut = n(feed[F.tempOutC]);
      const humOut  = n(feed[F.humOutPct]);
      const uv      = n(feed[F.uvIndex]);
      const wind    = n(feed[F.windMs]);
      const rainRaw = feed[F.rainFlag];
      const rain = typeof rainRaw === 'string' ? (rainRaw.trim() === '1' || rainRaw.trim().toLowerCase() === 'true') : !!rainRaw;

      const tempInTxt  = isFinite(tempIn)  ? `${tempIn.toFixed(CONFIG.DECIMALS_TEMP)} °C` : '-- °C';
      const humInTxt   = isFinite(humIn)   ? `${humIn.toFixed(CONFIG.DECIMALS_HUM)} %`  : '-- %';
      const tempOutTxt = isFinite(tempOut) ? `${tempOut.toFixed(CONFIG.DECIMALS_TEMP)} °C` : '-- °C';
      const humOutTxt  = isFinite(humOut)  ? `${humOut.toFixed(CONFIG.DECIMALS_HUM)} %`  : '-- %';
      const uvTxt      = isFinite(uv)      ? `${uv.toFixed(1)}` : '--';
      const windTxt    = isFinite(wind)    ? `${wind.toFixed(CONFIG.DECIMALS_WIND)} m/s` : '-- m/s';
      const rainTxt    = rain ? 'Ja' : 'Nein';

      // Karten
      document.getElementById('tempInCard').textContent  = tempInTxt;
      document.getElementById('humInCard').textContent   = humInTxt;
      document.getElementById('tempOutCard').textContent = tempOutTxt;
      document.getElementById('humOutCard').textContent  = humOutTxt;
      document.getElementById('uvCard').textContent      = uvTxt;
      document.getElementById('rainCard').textContent    = rainTxt;
      document.getElementById('windCard').textContent    = windTxt;

      // SVG
      const sun = document.getElementById('sunGroup');
      const pinwheel = document.getElementById('vanes');

      document.getElementById('tempInValue').textContent  = tempInTxt;
      document.getElementById('humInValue').textContent   = humInTxt;
      document.getElementById('tempOutValue').textContent = tempOutTxt;
      document.getElementById('humOutValue').textContent  = humOutTxt;
      document.getElementById('uvValue').textContent      = `UV – ${uvTxt}`;
      document.getElementById('rainValue').textContent    = `Regen: ${rainTxt}`;
      document.getElementById('windValue').textContent    = `Wind: ${windTxt}`;

      // UV Highlight
      if (isFinite(uv) && uv >= 6) sun.classList.add('blink'); else sun.classList.remove('blink');

      // Wind: Drehgeschwindigkeit ~ Wind (Begrenzung, damit's nicht ausrastet)
      const baseDur = 6; // Sekunden bei 0 m/s
      const speed = Math.max(0, Math.min(isFinite(wind) ? wind : 0, 20));
      const dur = Math.max(0.8, baseDur - speed * 0.25); // schneller bei mehr Wind
      pinwheel.style.animationDuration = `${dur}s`;
      pinwheel.classList.add('spin');

      // Zeitstempel
      const tsEl = document.getElementById('timestamp');
      const ts   = feed.created_at || new Date().toISOString();
      const dt   = new Date(ts);
      tsEl.textContent = `Letzte Aktualisierung: ${dt.toLocaleString()}`;

      // ARIA
      document.getElementById('houseScene').setAttribute('aria-label', `Werte innen: ${tempInTxt}, ${humInTxt}. außen: ${tempOutTxt}, ${humOutTxt}. UV ${uvTxt}, Wind ${windTxt}, Regen ${rainTxt}.`);
    }

    // Auto-Refresh alle 60s
    let interval = setInterval(fetchFromThingSpeak, 60000);
    document.getElementById('refreshBtn').addEventListener('click', fetchFromThingSpeak);
    fetchFromThingSpeak();
  </script>
</body>
</html>
