<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Beni`s Wetterstation</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="description" content="Vollbild, smartphone-optimierte Wetter-Grafik mit Innen-/Außenwerten, UV/Nachtmodus, Wind & Regen aus ThingSpeak." />
  <style>
    html, body { height: 100%; }
    .metric { font-variant-numeric: tabular-nums; }
    .blink { animation: blink 1.2s linear infinite; }
    @keyframes blink { 50% { opacity: .4 } }
    .spin { animation-name: spin; animation-iteration-count: infinite; animation-timing-function: linear; }
    @keyframes spin { from { transform: rotate(0deg) } to { transform: rotate(360deg) } }
  </style>
</head>
<body class="h-screen w-screen overflow-hidden bg-black text-slate-100 antialiased">
  <!-- Overlay-Header (fixiert) -->
  <div class="pointer-events-none fixed inset-x-0 top-0 z-20 flex items-center justify-between px-4" style="padding-top: env(safe-area-inset-top);">
    <h1 class="pointer-events-auto select-none text-lg font-bold drop-shadow">Beni`s Wetterstation</h1>
    <button id="refreshBtn" class="pointer-events-auto px-3 py-1.5 rounded-full bg-white/20 hover:bg-white/30 backdrop-blur text-white text-sm">Aktualisieren</button>
  </div>

  <!-- Vollbild-Szene -->
  <main class="h-[100svh] w-screen">
    <svg id="houseScene" viewBox="0 0 900 540" preserveAspectRatio="xMidYMid slice" class="h-full w-full">
      <defs>
        <linearGradient id="skyGradDay" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stop-color="#cfeffd" />
          <stop offset="100%" stop-color="#eaf6ff" />
        </linearGradient>
        <linearGradient id="skyGradNight" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stop-color="#0b1d3a" />
          <stop offset="100%" stop-color="#0f2350" />
        </linearGradient>
        <linearGradient id="roofGrad" x1="0" y1="0" x2="1" y2="1">
          <stop offset="0%" stop-color="#f472b6" />
          <stop offset="100%" stop-color="#fb7185" />
        </linearGradient>
        <linearGradient id="wallGrad" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stop-color="#f8fafc" />
          <stop offset="100%" stop-color="#e2e8f0" />
        </linearGradient>
        <filter id="shadow" x="-50%" y="-50%" width="200%" height="200%">
          <feDropShadow dx="0" dy="3" stdDeviation="6" flood-opacity="0.18"/>
        </filter>
      </defs>

      <!-- Himmel (wechselbar) -->
      <rect id="sky" x="0" y="0" width="900" height="540" fill="url(#skyGradDay)"/>

      <!-- Sonne / Mond -->
      <g id="sunGroup" transform="translate(120,120)" filter="url(#shadow)">
        <circle r="56" fill="#ffd166" />
        <text id="uvValue" x="0" y="8" text-anchor="middle" font-size="22" font-weight="700" fill="#7c4a00">UV – --</text>
      </g>
      <g id="moonGroup" transform="translate(120,120)" opacity="0">
        <circle r="44" fill="#f1f5f9" />
        <circle r="40" cx="10" cy="-6" fill="#0f2350" />
      </g>

      <!-- Wolken + Regen -->
      <g id="cloudGroup" transform="translate(720,130)" filter="url(#shadow)">
        <ellipse rx="64" ry="34" cx="0" cy="10" fill="#ffffff"/>
        <ellipse rx="50" ry="30" cx="-50" cy="22" fill="#ffffff"/>
        <ellipse rx="50" ry="30" cx="50" cy="22" fill="#ffffff"/>
        <text id="rainValue" x="0" y="65" text-anchor="middle" font-size="18" font-weight="600" fill="#334155">Regen: --</text>
      </g>

      <!-- Wiese / Boden -->
      <rect x="0" y="450" width="900" height="90" fill="#bbf7d0"/>

      <!-- Wind-Pinwheel links -->
      <g id="windGroup" transform="translate(80,410)" filter="url(#shadow)">
        <line x1="0" y1="0" x2="0" y2="-80" stroke="#64748b" stroke-width="6"/>
        <g id="pinwheel" transform="translate(0,-80)">
          <circle r="6" fill="#64748b"/>
          <g id="vanes">
            <path d="M0,0 L0,-28 Q12,-22 16,-10 Z" fill="#94a3b8"/>
            <path d="M0,0 L28,0 Q22,12 10,16 Z" fill="#94a3b8"/>
            <path d="M0,0 L0,28 Q-12,22 -16,10 Z" fill="#94a3b8"/>
            <path d="M0,0 L-28,0 Q-22,-12 -10,-16 Z" fill="#94a3b8"/>
          </g>
        </g>
        <text id="windValue" x="-10" y="22" text-anchor="start" font-size="18" font-weight="700" fill="#0f172a">Wind: --</text>
      </g>

      <!-- Haus -->
      <g id="houseGroup" transform="translate(360,270)" filter="url(#shadow)">
        <!-- Dach -->
        <polygon points="-170,0 0,-110 170,0" fill="url(#roofGrad)" stroke="#f43f5e" stroke-width="2"/>
        <!-- Kamin -->
        <rect x="70" y="-110" width="24" height="46" fill="#ef4444" stroke="#b91c1c"/>
        <circle cx="82" cy="-120" r="5" fill="#e5e7eb"/>
        <circle cx="88" cy="-128" r="7" fill="#e5e7eb" opacity=".7"/>

        <!-- Wände -->
        <rect x="-150" y="0" width="300" height="160" rx="14" ry="14" fill="url(#wallGrad)" stroke="#cbd5e1" stroke-width="2"/>

        <!-- Innenwerte -->
        <g id="windowTempIn" transform="translate(-100,44)">
          <rect width="96" height="72" rx="14" ry="14" fill="#ffffff" stroke="#cbd5e1"/>
          <text id="tempInValue" x="48" y="40" text-anchor="middle" font-size="20" font-weight="700" fill="#0f172a">-- °C</text>
          <text x="48" y="60" text-anchor="middle" font-size="12" fill="#475569">Innen Temp</text>
        </g>
        <g id="windowHumIn" transform="translate(4,44)">
          <rect width="96" height="72" rx="14" ry="14" fill="#ffffff" stroke="#cbd5e1"/>
          <text id="humInValue" x="48" y="40" text-anchor="middle" font-size="20" font-weight="700" fill="#0f172a">-- %</text>
          <text x="48" y="60" text-anchor="middle" font-size="12" fill="#475569">Innen Feuchte</text>
        </g>

        <!-- Tür -->
        <g id="door" transform="translate(120,34)">
          <rect width="56" height="116" rx="10" ry="10" fill="#f59e0b" stroke="#a16207"/>
          <circle cx="44" cy="60" r="3.5" fill="#7c2d12"/>
        </g>

        <!-- Außenwerte rechts -->
        <g id="outsidePanel" transform="translate(220,20)">
          <g id="windowTempOut" transform="translate(0,0)">
            <rect width="96" height="72" rx="16" ry="16" fill="#ffffff" stroke="#cbd5e1"/>
            <text id="tempOutValue" x="48" y="40" text-anchor="middle" font-size="20" font-weight="700" fill="#0f172a">-- °C</text>
            <text x="48" y="60" text-anchor="middle" font-size="12" fill="#475569">Außen Temp</text>
          </g>
          <g id="windowHumOut" transform="translate(0,88)">
            <rect width="96" height="72" rx="16" ry="16" fill="#ffffff" stroke="#cbd5e1"/>
            <text id="humOutValue" x="48" y="40" text-anchor="middle" font-size="20" font-weight="700" fill="#0f172a">-- %</text>
            <text x="48" y="60" text-anchor="middle" font-size="12" fill="#475569">Außen Feuchte</text>
          </g>
        </g>
      </g>

      <!-- Nacht-Overlay (Sterne) -->
      <g id="nightOverlay" opacity="0">
        <g fill="#ffffff">
          <circle cx="760" cy="90" r="1.2"/>
          <circle cx="700" cy="60" r="1.5"/>
          <circle cx="640" cy="120" r="1.1"/>
          <circle cx="500" cy="80" r="1.4"/>
          <circle cx="420" cy="50" r="1.2"/>
          <circle cx="240" cy="70" r="1.1"/>
          <circle cx="180" cy="140" r="1.3"/>
        </g>
      </g>

      <!-- Zeitstempel unten -->
      <text id="timestamp" x="450" y="520" text-anchor="middle" font-size="14" fill="#334155">Letzte Aktualisierung: --</text>
    </svg>
  </main>

  <script>
    const CONFIG = {
      CHANNEL_ID: "YOUR_CHANNEL_ID_HERE",
      READ_API_KEY: "YOUR_READ_API_KEY_HERE", // leer lassen, wenn öffentlich
      FIELD_MAPPING: {
        tempOutC:  "field1",
        humOutPct: "field2",
        tempInC:   "field3",
        humInPct:  "field4",
        uvIndex:   "field5",
        rainFlag:  "field6",
        windMs:    "field7",
      },
      NUM_RESULTS: 1,
      DECIMALS_TEMP: 1,
      DECIMALS_HUM: 0,
      DECIMALS_WIND: 1,
      UV_NIGHT_THRESHOLD: 0.1,
    };

    async function fetchFromThingSpeak() {
      const base = `https://api.thingspeak.com/channels/${CONFIG.CHANNEL_ID}/feeds.json`;
      const params = new URLSearchParams({ results: String(CONFIG.NUM_RESULTS) });
      if (CONFIG.READ_API_KEY && CONFIG.READ_API_KEY !== "YOUR_READ_API_KEY_HERE") params.set("api_key", CONFIG.READ_API_KEY);
      const url = `${base}?${params.toString()}`;
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        if (!data.feeds || !data.feeds.length) throw new Error('Keine Daten gefunden');
        const latest = data.feeds[data.feeds.length - 1];
        applyData(latest);
      } catch (err) {
        console.error(err);
      }
    }

    function n(x) { const v = parseFloat(x); return isFinite(v) ? v : NaN; }

    function applyData(feed) {
      const F = CONFIG.FIELD_MAPPING;
      const tempIn  = n(feed[F.tempInC]);
      const humIn   = n(feed[F.humInPct]);
      const tempOut = n(feed[F.tempOutC]);
      const humOut  = n(feed[F.humOutPct]);
      const uv      = n(feed[F.uvIndex]);
      const wind    = n(feed[F.windMs]);
      const rainRaw = feed[F.rainFlag];
      const rain    = typeof rainRaw === 'string' ? (rainRaw.trim() === '1' || rainRaw.trim().toLowerCase() === 'true') : !!rainRaw;

      const tIn  = isFinite(tempIn)  ? `${tempIn.toFixed(CONFIG.DECIMALS_TEMP)} °C` : '-- °C';
      const hIn  = isFinite(humIn)   ? `${humIn.toFixed(CONFIG.DECIMALS_HUM)} %`  : '-- %';
      const tOut = isFinite(tempOut) ? `${tempOut.toFixed(CONFIG.DECIMALS_TEMP)} °C` : '-- °C';
      const hOut = isFinite(humOut)  ? `${humOut.toFixed(CONFIG.DECIMALS_HUM)} %`  : '-- %';
      const uvTx = isFinite(uv)      ? `${uv.toFixed(1)}` : '--';
      const wTx  = isFinite(wind)    ? `${wind.toFixed(CONFIG.DECIMALS_WIND)} m/s` : '-- m/s';
      const rTx  = rain ? 'Ja' : 'Nein';

      // SVG Werte
      document.getElementById('tempInValue').textContent  = tIn;
      document.getElementById('humInValue').textContent   = hIn;
      document.getElementById('tempOutValue').textContent = tOut;
      document.getElementById('humOutValue').textContent  = hOut;
      document.getElementById('uvValue').textContent      = `UV – ${uvTx}`;
      document.getElementById('rainValue').textContent    = `Regen: ${rTx}`;
      document.getElementById('windValue').textContent    = `Wind: ${wTx}`;

      // UV/Nachtmodus
      const sun = document.getElementById('sunGroup');
      const moon = document.getElementById('moonGroup');
      const sky  = document.getElementById('sky');
      const stars= document.getElementById('nightOverlay');

      if (isFinite(uv) && uv >= 6) sun.classList.add('blink'); else sun.classList.remove('blink');
      const isNight = isFinite(uv) ? (uv <= CONFIG.UV_NIGHT_THRESHOLD) : false;
      if (isNight) {
        sky.setAttribute('fill', 'url(#skyGradNight)');
        sun.setAttribute('opacity', '0');
        moon.setAttribute('opacity', '1');
        stars.setAttribute('opacity', '1');
      } else {
        sky.setAttribute('fill', 'url(#skyGradDay)');
        sun.setAttribute('opacity', '1');
        moon.setAttribute('opacity', '0');
        stars.setAttribute('opacity', '0');
      }

      // Windrotation
      const pinwheel = document.getElementById('vanes');
      const baseDur = 6; // s bei 0 m/s
      const speed = Math.max(0, Math.min(isFinite(wind) ? wind : 0, 20));
      pinwheel.style.animationDuration = `${Math.max(0.8, baseDur - speed * 0.25)}s`;
      pinwheel.classList.add('spin');

      // Zeitstempel
      const tsEl = document.getElementById('timestamp');
      const ts   = feed.created_at || new Date().toISOString();
      tsEl.textContent = `Letzte Aktualisierung: ${new Date(ts).toLocaleString()}`;

      // ARIA
      document.getElementById('houseScene').setAttribute('aria-label', `Innen: ${tIn}, ${hIn}. Außen: ${tOut}, ${hOut}. UV ${uvTx}, Wind ${wTx}, Regen ${rTx}.`);
    }

    // Auto-Refresh alle 60s
    setInterval(fetchFromThingSpeak, 60000);
    document.getElementById('refreshBtn').addEventListener('click', fetchFromThingSpeak);
    fetchFromThingSpeak();
  </script>
</body>
</html>
